<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (å¤§ããªæ–‡å­—ç‰ˆ)</title>
    <style>
        /* ãƒ™ãƒ¼ã‚¹ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ããè¨­å®š */
        body { 
            font-family: "Helvetica Neue", Arial, sans-serif; 
            margin: 20px; 
            background: #f8f9fa; 
            color: #222; 
            font-size: 18px; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
        }
        
        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ï¼ˆã‚¢ã‚¤ã‚³ãƒ³å‰Šé™¤ï¼‰ */
        h1 { font-size: 32px; text-align: center; margin-bottom: 30px; color: #2c3e50; }
        
        h2 { font-size: 28px; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 40px; }
        h3 { font-size: 24px; margin-top: 30px; margin-bottom: 15px; background: #e9ecef; padding: 10px; border-radius: 8px; }
        
        /* ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã‚¨ãƒªã‚¢ */
        .member-management { padding: 20px; text-align: center; border: 2px solid #dee2e6; border-radius: 10px; margin-bottom: 30px; }
        .member-chip { 
            background: #0056b3; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 30px; 
            display: inline-flex; 
            align-items: center; 
            gap: 15px; 
            font-size: 18px; 
            margin: 5px;
            font-weight: bold;
        }
        .member-chip button { 
            background: white; color: #0056b3; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; line-height: 1; cursor: pointer; border: none; 
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        input[type="text"], input[type="number"], select { 
            padding: 12px; 
            font-size: 20px; 
            border: 2px solid #aaa; 
            border-radius: 6px; 
            margin: 5px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š */
        .table-wrapper { overflow-x: auto; margin-bottom: 30px; border: 2px solid #aaa; }
        table { border-collapse: collapse; width: 100%; text-align: center; min-width: 800px; }
        
        th, td { 
            border: 1px solid #999; 
            padding: 10px; 
            font-size: 18px; 
            vertical-align: middle;
        }
        th { background: #e9ecef; font-weight: bold; position: sticky; top: 0; z-index: 10; font-size: 20px; }
        .sticky-date { position: sticky; left: 0; background: #e9ecef; font-weight: bold; z-index: 5; font-size: 20px; }

        /* åœŸæ—¥ç¥ã®è‰²åˆ†ã‘ */
        .sat { color: #0044cc; background: #eef6ff; font-weight: bold; }
        .sun, .hol { color: #cc0000; background: #ffebeb; font-weight: bold; }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å·¨å¤§åŒ– */
        input[type="checkbox"] {
            transform: scale(2.5); 
            margin: 10px;
            cursor: pointer;
        }

        /* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .btn-group { display: flex; justify-content: center; gap: 20px; margin: 40px 0; }
        button.primary { 
            padding: 20px 60px; 
            font-size: 24px; 
            cursor: pointer; 
            border: none; 
            border-radius: 50px; 
            background: #28a745; 
            color: white; 
            font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        button.sub { 
            padding: 15px 30px; 
            font-size: 18px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
        }
        button:hover { opacity: 0.9; transform: translateY(-2px); }

        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ - â—ã‚’å·¨å¤§åŒ– */
        .work-cell { 
            color: #28a745; 
            font-weight: 900; 
            font-size: 42px; /* â†ã“ã“ã‚’å¤§ããå¤‰æ›´ */
            line-height: 1;
        } 
        .off-cell { color: #ddd; font-size: 20px; }
        
        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-layout { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 30px; }
        .stats-card { 
            background: #fff; 
            border: 2px solid #ccc; 
            padding: 15px; 
            border-radius: 10px; 
            min-width: 180px; 
            font-size: 18px; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); 
        }
        .stats-card b { font-size: 22px; display: block; margin-bottom: 10px; color: #0056b3; }
        .wd-count { font-size: 16px; margin-top: 5px; line-height: 1.5; color: #444; }

        @media print { 
            .no-print { display: none !important; } 
            .container { box-shadow: none; border: none; width: 100%; margin: 0; padding: 0; } 
            body { font-size: 14pt; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="no-print">ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

    <div class="member-management no-print">
        <h3>ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h3>
        <div class="member-input">
            <input type="text" id="newMemberName" class="txt-input" placeholder="åå‰ã‚’å…¥åŠ›">
            <button class="sub" onclick="addMember()">è¿½åŠ </button>
        </div>
        <div class="member-list" id="memberListArea"></div>
    </div>

    <div class="config-section no-print" style="text-align: center; background:#eee; padding:20px; border-radius:10px;">
        <label>è¨­å®šï¼š</label>
        <input type="number" id="yearInput" value="2026" min="2025" onchange="init()" style="width:100px;">å¹´
        <select id="monthInput" onchange="init()">
            <option value="1">1æœˆ</option><option value="2" selected>2æœˆ</option>
            <option value="3">3æœˆ</option><option value="4">4æœˆ</option>
            <option value="5">5æœˆ</option><option value="6">6æœˆ</option>
            <option value="7">7æœˆ</option><option value="8">8æœˆ</option>
            <option value="9">9æœˆ</option><option value="10">10æœˆ</option>
            <option value="11">11æœˆ</option><option value="12">12æœˆ</option>
        </select>æœˆ
        <br><br>
        <select id="periodInput" onchange="init()" style="width:100%;">
            <option value="first" selected>å‰åŠ (11æ—¥ã€œ26æ—¥)</option>
            <option value="second">å¾ŒåŠ (27æ—¥ã€œç¿Œ10æ—¥)</option>
        </select>
    </div>

    <h3 class="no-print">1. å‡ºå‹¤ã§ãã‚‹æ—¥ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</h3>
    <div class="table-wrapper no-print" id="inputGrid"></div>
    
    <div class="btn-group no-print">
        <button class="primary" onclick="generateShift()">âœ¨ ã‚·ãƒ•ãƒˆã‚’ä½œæˆã™ã‚‹</button>
    </div>

    <div id="resultArea" style="display:none;">
        <hr class="no-print" style="margin: 40px 0;">
        <h2 id="resultTitle">ã‚·ãƒ•ãƒˆçµæœ</h2>
        
        <h3 class="no-print">å‡ºå‹¤å›æ•°ãƒ»æ›œæ—¥å†…è¨³</h3>
        <div class="stats-layout" id="statsArea"></div>

        <h3>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</h3>
        <div class="table-wrapper" id="calendarTableWrapper"></div>
        <div class="btn-group no-print">
            <button class="sub" style="background:#17a2b8" onclick="copyToClipboard()">ğŸ“‹ Excelç”¨ã«ã‚³ãƒ”ãƒ¼</button>
            <button class="sub" style="background:#6c757d" onclick="window.print()">ğŸ–¨ å°åˆ· / PDFä¿å­˜</button>
        </div>
    </div>
</div>

<script>
// ã‚¹ã‚¿ãƒƒãƒ•è¨­å®š
let members = ['æ‰æœ¬', 'å°è°·ç”°', 'è—¤äº•', 'å·¥è—¤', 'æ¾¤äº•', 'å¤§é–“'];

function getDateList(year, month, period) {
    let dates = [];
    if (period === 'first') {
        for (let d = 11; d <= 26; d++) { dates.push(new Date(year, month - 1, d)); }
    } else {
        let lastDay = new Date(year, month, 0).getDate();
        for (let d = 27; d <= lastDay; d++) { dates.push(new Date(year, month - 1, d)); }
        for (let d = 1; d <= 10; d++) { dates.push(new Date(year, month, d)); }
    }
    return dates;
}

function addMember() {
    const input = document.getElementById('newMemberName');
    const name = input.value.trim();
    if (name && !members.includes(name)) {
        members.push(name);
        input.value = '';
        renderMemberList();
        init();
    }
}

function removeMember(name) {
    if (members.length <= 2) { alert("æœ€ä½2åã®ç™»éŒ²ãŒå¿…è¦ã§ã™"); return; }
    if(confirm(name + "ã•ã‚“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        members = members.filter(m => m !== name);
        renderMemberList();
        init();
    }
}

function renderMemberList() {
    const area = document.getElementById('memberListArea');
    area.innerHTML = members.map(m => `
        <div class="member-chip">
            ${m} <button onclick="removeMember('${m}')">Ã—</button>
        </div>
    `).join('');
}

function isHoliday(dateObj) {
    const y = dateObj.getFullYear();
    const m = dateObj.getMonth() + 1;
    const d = dateObj.getDate();
    const h = { 1:[1], 2:[11, 23], 4:[29], 5:[3,4,5], 7:[20], 8:[11], 9:[23], 11:[3,23] }; 
    if (h[m] && h[m].includes(d)) return true;
    return false;
}

function init() {
    const y = parseInt(document.getElementById('yearInput').value);
    const m = parseInt(document.getElementById('monthInput').value);
    const p = document.getElementById('periodInput').value;
    const dates = getDateList(y, m, p);

    let html = `<table><tr><th class="sticky-date">æ—¥ä»˜</th>`;
    members.forEach(mName => html += `<th>${mName}</th>`);
    html += `</tr>`;

    dates.forEach(dt => {
        const hol = isHoliday(dt);
        const dayIdx = dt.getDay();
        const dStr = `${dt.getMonth()+1}/${dt.getDate()}`;
        const cls = (dayIdx === 0 || hol) ? 'sun' : (dayIdx === 6 ? 'sat' : '');
        const dateKey = `${dt.getFullYear()}-${dt.getMonth()+1}-${dt.getDate()}`;

        html += `<tr class="${cls}">
            <td class="sticky-date">${dStr} (${"æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[dayIdx]})</td>`;
        members.forEach(mName => {
            html += `<td><input type="checkbox" id="check_${mName}_${dateKey}"></td>`;
        });
        html += `</tr>`;
    });
    document.getElementById('inputGrid').innerHTML = html + `</table>`;
}

function generateShift() {
    const y = parseInt(document.getElementById('yearInput').value);
    const m = parseInt(document.getElementById('monthInput').value);
    const p = document.getElementById('periodInput').value;
    const dates = getDateList(y, m, p);

    let stats = {};
    members.forEach(m1 => { 
        stats[m1] = { total: 0, weekend: 0, wdCounts: [0,0,0,0,0,0,0] }; 
    });

    let results = {};
    let yesterdayWork = [];

    for (let i = 0; i < dates.length; i++) {
        const dt = dates[i];
        const dateKey = `${dt.getFullYear()}-${dt.getMonth()+1}-${dt.getDate()}`;
        const dayIdx = dt.getDay();
        const isWe = (dayIdx === 0 || dayIdx === 6 || isHoliday(dt));
        const required = 2; 

        let avail = members.filter(mName => {
            const el = document.getElementById(`check_${mName}_${dateKey}`);
            return el && el.checked;
        });

        let candidates = avail.filter(mName => !yesterdayWork.includes(mName));
        if (candidates.length < required) candidates = avail; 
        
        if (candidates.length < required) { 
            alert(`${dt.getMonth()+1}/${dt.getDate()}ã®å€™è£œè€…ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆæœ€ä½${required}åï¼‰`); 
            return; 
        }

        candidates.sort((a, b) => (stats[a].total - stats[b].total) + (Math.random() - 0.5));
        
        const selected = candidates.slice(0, required);
        results[dateKey] = selected;

        selected.forEach(mName => {
            stats[mName].total++;
            if (isWe) stats[mName].weekend++;
            stats[mName].wdCounts[dayIdx]++;
        });
        yesterdayWork = selected;
    }
    renderResults(results, stats, dates, y, m, p);
}

function renderResults(res, stats, dates, y, m, p) {
    document.getElementById('resultArea').style.display = 'block';
    
    const pText = (p === 'first') ? "å‰åŠ (11-26æ—¥)" : "å¾ŒåŠ (27-10æ—¥)";
    document.getElementById('resultTitle').innerText = `${y}å¹´${m}æœˆåº¦ ${pText} ã‚·ãƒ•ãƒˆçµæœ`;
    
    const weekNames = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
    let sHtml = '';
    members.forEach(mName => {
        const st = stats[mName];
        let wdHtml = '';
        st.wdCounts.forEach((count, idx) => {
            if(count > 0) wdHtml += `<span>${weekNames[idx]}:${count}</span> `;
        });

        sHtml += `
        <div class="stats-card">
            <b>${mName}</b>
            åˆè¨ˆ: ${st.total}å› <br>
            <span style="font-size:16px">(åœŸæ—¥ç¥ ${st.weekend})</span>
            <hr style="margin:10px 0; border:0; border-top:2px dashed #ccc;">
            <div style="font-size:16px; color:#444;">${wdHtml}</div>
        </div>`;
    });
    document.getElementById('statsArea').innerHTML = sHtml;

    let cHtml = `<table id="shareTable"><tr><th class="sticky-date">æ—¥ä»˜</th>`;
    members.forEach(mName => cHtml += `<th>${mName}</th>`);
    cHtml += `</tr>`;

    dates.forEach(dt => {
        const dateKey = `${dt.getFullYear()}-${dt.getMonth()+1}-${dt.getDate()}`;
        const hol = isHoliday(dt);
        const dayIdx = dt.getDay();
        const dStr = `${dt.getMonth()+1}/${dt.getDate()}`;
        const cls = (dayIdx === 0 || hol) ? 'sun' : (dayIdx === 6 ? 'sat' : '');
        
        cHtml += `<tr class="${cls}"><td class="sticky-date">${dStr} (${weekNames[dayIdx]})</td>`;
        members.forEach(mName => {
            const work = res[dateKey] && res[dateKey].includes(mName);
            // ä¿®æ­£ç®‡æ‰€ï¼šâ—ä»¥å¤–ï¼ˆä¼‘ã¿ï¼‰ã®ãƒã‚¹ã«ãƒ»ã‚’è¡¨ç¤ºã—ã¦åˆ†ã‹ã‚Šã‚„ã™ã
            cHtml += `<td class="${work ? 'work-cell' : 'off-cell'}">${work ? 'â—' : 'ãƒ»'}</td>`;
        });
        cHtml += `</tr>`;
    });
    document.getElementById('calendarTableWrapper').innerHTML = cHtml + `</table>`;
    
    document.getElementById('resultArea').scrollIntoView({behavior: "smooth"});
}

function copyToClipboard() {
    const table = document.getElementById("shareTable");
    let text = "";
    for (let i = 0; i < table.rows.length; i++) {
        let row = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) { row.push(table.rows[i].cells[j].innerText.replace('â—','â—‹').replace('ãƒ»','')); }
        text += row.join("\t") + "\n";
    }
    navigator.clipboard.writeText(text).then(() => alert("Excelè²¼ã‚Šä»˜ã‘ç”¨ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
}

// åˆæœŸåŒ–å®Ÿè¡Œ
renderMemberList();
init();
</script>
</body>
</html>
